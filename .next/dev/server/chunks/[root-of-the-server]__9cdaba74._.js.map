{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///data/OpenAlex-Analysis/InnoSciHub/scientific-knowledge-navigation/app/api/stream-model/route.ts"],"sourcesContent":["import fetch from 'node-fetch'\n\nexport const runtime = \"nodejs\"\n\nexport async function POST(req: Request) {\n  try {\n    const { prompt, config } = await req.json()\n    \n    let apiUrl = config.connectionURL\n    if (!apiUrl) {\n      apiUrl = config.baseURL || \"\"\n      if (!apiUrl.endsWith(\"/chat/completions\")) {\n        apiUrl += apiUrl.endsWith(\"/\") ? \"chat/completions\" : \"/chat/completions\"\n      }\n    }\n    \n    console.log(`[Stream API] Calling URL: ${apiUrl}`)\n    \n    const response = await fetch(apiUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${config.apiKey}`,\n      },\n      body: JSON.stringify({\n        model: config.model,\n        messages: [\n          { role: \"system\", content: \"You are a helpful AI assistant.\" },\n          { role: \"user\", content: prompt },\n        ],\n        stream: true,\n      }),\n    })\n    \n    if (!response.ok) {\n      const errorText = await response.text()\n      console.error(`[Stream API] Error ${response.status}:`, errorText)\n      return new Response(errorText || `Error ${response.status}`, { status: response.status })\n    }\n    \n    // 创建正确的SSE流式响应\n    const encoder = new TextEncoder()\n    const decoder = new TextDecoder()\n    const readableStream = new ReadableStream({\n      async start(controller) {\n        try {\n          if (!response.body) {\n            controller.close()\n            return\n          }\n          \n          let buffer = ''\n          \n          // 使用异步迭代器处理流\n          for await (const chunk of response.body as any) {\n            buffer += decoder.decode(chunk, { stream: true })\n            const lines = buffer.split('\\n')\n            buffer = lines.pop() || '' // 保留最后一个不完整的行\n            \n            for (const line of lines) {\n              if (line.trim() === '') continue\n              \n              if (line.includes('[DONE]')) {\n                const endData = `data: ${JSON.stringify({ done: true })}\\n\\n`\n                controller.enqueue(encoder.encode(endData))\n                controller.close()\n                return\n              }\n              \n              if (line.startsWith('data: ')) {\n                try {\n                  const jsonStr = line.slice(6).trim()\n                  if (jsonStr === '') continue\n                  \n                  const json = JSON.parse(jsonStr)\n                  if (json.choices && json.choices[0]?.delta?.content) {\n                    const content = json.choices[0].delta.content\n                    if (content) {\n                      // 发送SSE格式的数据\n                      const sseData = `data: ${JSON.stringify({ content })}\\n\\n`\n                      controller.enqueue(encoder.encode(sseData))\n                    }\n                  }\n                } catch (e) {\n                  console.log(\"解析SSE数据失败:\", line, e instanceof Error ? e.message : String(e))\n                }\n              }\n            }\n          }\n          \n          // 处理剩余的buffer\n          if (buffer.trim()) {\n            if (buffer.includes('[DONE]')) {\n              const endData = `data: ${JSON.stringify({ done: true })}\\n\\n`\n              controller.enqueue(encoder.encode(endData))\n            } else if (buffer.startsWith('data: ')) {\n              try {\n                const jsonStr = buffer.slice(6).trim()\n                const json = JSON.parse(jsonStr)\n                if (json.choices && json.choices[0]?.delta?.content) {\n                  const content = json.choices[0].delta.content\n                  if (content) {\n                    const sseData = `data: ${JSON.stringify({ content })}\\n\\n`\n                    controller.enqueue(encoder.encode(sseData))\n                  }\n                }\n              } catch (e) {\n                console.log(\"解析剩余数据失败:\", buffer, e instanceof Error ? e.message : String(e))\n              }\n            }\n          }\n          \n          // 发送完成信号\n          const endData = `data: ${JSON.stringify({ done: true })}\\n\\n`\n          controller.enqueue(encoder.encode(endData))\n          controller.close()\n        } catch (error) {\n          console.error(\"[Stream API] Stream processing error:\", error)\n          controller.error(error)\n        }\n      }\n    })\n    \n    return new Response(readableStream, {\n      headers: {\n        'Content-Type': 'text/event-stream',\n        'Cache-Control': 'no-cache',\n        'Connection': 'keep-alive',\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Headers': 'Content-Type',\n      },\n    })\n  } catch (error: any) {\n    console.error(\"[Stream API] Exception:\", error)\n    return new Response(`Server Error: ${error.message}`, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}