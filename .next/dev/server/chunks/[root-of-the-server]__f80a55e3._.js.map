{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///data/OpenAlex-Analysis/InnoSciHub/scientific-knowledge-navigation/app/api/stream-model/route.ts"],"sourcesContent":["export const runtime = \"nodejs\"\n\nexport async function POST(req: Request) {\n  try {\n    const { prompt, config } = await req.json()\n    \n    let apiUrl = config.connectionURL\n    if (!apiUrl) {\n      apiUrl = config.baseURL || \"\"\n      if (!apiUrl.endsWith(\"/chat/completions\")) {\n        apiUrl += apiUrl.endsWith(\"/\") ? \"chat/completions\" : \"/chat/completions\"\n      }\n    }\n    \n    console.log(`[Stream API] Calling URL: ${apiUrl}`)\n    \n    const response = await fetch(apiUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${config.apiKey}`,\n      },\n      body: JSON.stringify({\n        model: config.model,\n        messages: [\n          { role: \"system\", content: \"You are a helpful AI assistant.\" },\n          { role: \"user\", content: prompt },\n        ],\n        stream: true,\n      }),\n    })\n    \n    if (!response.ok) {\n      const errorText = await response.text()\n      console.error(`[Stream API] Error ${response.status}:`, errorText)\n      return new Response(errorText || `Error ${response.status}`, { status: response.status })\n    }\n    \n    // 创建一个简单的文本流响应\n    const encoder = new TextEncoder()\n    const readableStream = new ReadableStream({\n      async start(controller) {\n        try {\n          const reader = response.body?.getReader()\n          if (!reader) {\n            controller.close()\n            return\n          }\n          \n          const decoder = new TextDecoder()\n          \n          while (true) {\n            const { done, value } = await reader.read()\n            if (done) break\n            \n            const lines = decoder.decode(value).split('\\n')\n            for (const line of lines) {\n              if (line.trim() === '') continue\n              \n              try {\n                const json = JSON.parse(line.slice(6)) // 移除 \"data: \" 前缀\n                if (json.choices && json.choices[0]?.delta?.content) {\n                  const content = json.choices[0].delta.content\n                  if (content) {\n                    controller.enqueue(encoder.encode(content))\n                  }\n                }\n              } catch (e) {\n                // 忽略无法解析的行\n              }\n            }\n          }\n          \n          controller.close()\n        } catch (error) {\n          console.error(\"[Stream API] Stream processing error:\", error)\n          controller.error(error)\n        }\n      }\n    })\n    \n    return new Response(readableStream, {\n      headers: {\n        \"Content-Type\": \"text/plain; charset=utf-8\",\n        \"Cache-Control\": \"no-cache\",\n        \"Connection\": \"keep-alive\",\n      },\n    })\n  } catch (error: any) {\n    console.error(\"[Stream API] Exception:\", error)\n    return new Response(`Server Error: ${error.message}`, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,UAAU;AAEhB,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;QAEzC,IAAI,SAAS,OAAO,aAAa;QACjC,IAAI,CAAC,QAAQ;YACX,SAAS,OAAO,OAAO,IAAI;YAC3B,IAAI,CAAC,OAAO,QAAQ,CAAC,sBAAsB;gBACzC,UAAU,OAAO,QAAQ,CAAC,OAAO,qBAAqB;YACxD;QACF;QAEA,QAAQ,GAAG,CAAC,CAAC,0BAA0B,EAAE,QAAQ;QAEjD,MAAM,WAAW,MAAM,MAAM,QAAQ;YACnC,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,iBAAiB,CAAC,OAAO,EAAE,OAAO,MAAM,EAAE;YAC5C;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO,OAAO,KAAK;gBACnB,UAAU;oBACR;wBAAE,MAAM;wBAAU,SAAS;oBAAkC;oBAC7D;wBAAE,MAAM;wBAAQ,SAAS;oBAAO;iBACjC;gBACD,QAAQ;YACV;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,QAAQ,KAAK,CAAC,CAAC,mBAAmB,EAAE,SAAS,MAAM,CAAC,CAAC,CAAC,EAAE;YACxD,OAAO,IAAI,SAAS,aAAa,CAAC,MAAM,EAAE,SAAS,MAAM,EAAE,EAAE;gBAAE,QAAQ,SAAS,MAAM;YAAC;QACzF;QAEA,eAAe;QACf,MAAM,UAAU,IAAI;QACpB,MAAM,iBAAiB,IAAI,eAAe;YACxC,MAAM,OAAM,UAAU;gBACpB,IAAI;oBACF,MAAM,SAAS,SAAS,IAAI,EAAE;oBAC9B,IAAI,CAAC,QAAQ;wBACX,WAAW,KAAK;wBAChB;oBACF;oBAEA,MAAM,UAAU,IAAI;oBAEpB,MAAO,KAAM;wBACX,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,OAAO,IAAI;wBACzC,IAAI,MAAM;wBAEV,MAAM,QAAQ,QAAQ,MAAM,CAAC,OAAO,KAAK,CAAC;wBAC1C,KAAK,MAAM,QAAQ,MAAO;4BACxB,IAAI,KAAK,IAAI,OAAO,IAAI;4BAExB,IAAI;gCACF,MAAM,OAAO,KAAK,KAAK,CAAC,KAAK,KAAK,CAAC,IAAI,iBAAiB;;gCACxD,IAAI,KAAK,OAAO,IAAI,KAAK,OAAO,CAAC,EAAE,EAAE,OAAO,SAAS;oCACnD,MAAM,UAAU,KAAK,OAAO,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO;oCAC7C,IAAI,SAAS;wCACX,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;oCACpC;gCACF;4BACF,EAAE,OAAO,GAAG;4BACV,WAAW;4BACb;wBACF;oBACF;oBAEA,WAAW,KAAK;gBAClB,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,yCAAyC;oBACvD,WAAW,KAAK,CAAC;gBACnB;YACF;QACF;QAEA,OAAO,IAAI,SAAS,gBAAgB;YAClC,SAAS;gBACP,gBAAgB;gBAChB,iBAAiB;gBACjB,cAAc;YAChB;QACF;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,IAAI,SAAS,CAAC,cAAc,EAAE,MAAM,OAAO,EAAE,EAAE;YAAE,QAAQ;QAAI;IACtE;AACF"}}]
}